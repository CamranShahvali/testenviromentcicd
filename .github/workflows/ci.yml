name: CI Pipeline  # Workflow name, shows in GitHub Actions

on:
  workflow_run:
    workflows: ["pre-commit checks"]  # Must match pre-commit workflow name exactly
    types:
      - completed

jobs:
  # -----------------------------
  # Job 1: Lint + Pre-SAST
  # -----------------------------
  lint-sast:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Go lint
        run: |
          cd go-connect-backend
          go vet ./...

      - name: Rust lint
        run: |
          cd rust-grpc-backend
          cargo clippy --all-targets -- -D warnings

      - name: Frontend lint
        run: |
          cd frontend
          yarn install
          yarn lint

  # -----------------------------
  # Job 2: Deep SAST
  # -----------------------------
  sast:
    runs-on: ubuntu-latest
    needs: lint-sast
    steps:
      - uses: actions/checkout@v4

      - name: Snyk Code Scan
        uses: snyk/actions/snyk@master
        with:
          command: test
          path: ./frontend
          project-name: frontend-sast

      - name: Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: 'p/ci'

  # -----------------------------
  # Job 3: SCA Dependency Scans
  # -----------------------------
  sca:
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - uses: actions/checkout@v4

      - name: Node SCA
        run: |
          cd frontend
          yarn audit --level moderate

      - name: Go SCA
        run: |
          cd go-connect-backend
          govulncheck ./...

      - name: Rust SCA
        run: |
          cd rust-grpc-backend
          cargo audit

  # -----------------------------
  # Job 4: Docker Build + CVE Scan
  # -----------------------------
  docker-cve:
    runs-on: ubuntu-latest
    needs: sca
    steps:
      - uses: actions/checkout@v4

      - name: Build Alpine Docker Image
        run: docker build -t app:alpine -f Dockerfile.alpine .

      - name: Scan Alpine Image with Trivy
        id: trivy_alpine
        uses: aquasecurity/trivy-action@v0.20.0
        with:
          image-ref: app:alpine
          severity: MEDIUM,HIGH,CRITICAL
          exit-code: 0

      - name: Display Trivy Alpine Results
        run: cat ${{ steps.trivy_alpine.outputs.result-file }}

      - name: Build Chainguard if needed
        if: steps.trivy_alpine.outputs.exit-code != '0'
        run: docker build -t app:chainguard -f Dockerfile.chainguard .

      - name: Scan Chainguard Image with Trivy
        if: steps.trivy_alpine.outputs.exit-code != '0'
        uses: aquasecurity/trivy-action@v0.20.0
        with:
          image-ref: app:chainguard
          severity: MEDIUM,HIGH,CRITICAL
          exit-code: 1

  # -----------------------------
  # Job 5: CI Summary / PR Feedback
  # -----------------------------
  ci-summary:
    runs-on: ubuntu-latest
    needs: docker-cve
    steps:
      - name: Post CI Results to PR
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        with:
          message: |
            ✅ CI Pipeline completed
            - Lint/SAST ✅
            - SCA ✅
            - Docker/CVE ✅
